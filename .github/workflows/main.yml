# Run the rename script as dry-run or apply changes and open a PR.
# Trigger: Manually from Actions â†’ Run workflow
# Usage:
#  - Dry run: run workflow with apply = false (default). It will run scripts/rename.sh --dry and upload rename-plan.txt.
#  - Apply: run workflow with apply = true. It will create a new branch, run the script (no --dry), push the branch, and open a PR.
#
# Notes:
#  - The workflow uses the GITHUB_TOKEN; it needs write permissions to push branches and create PRs.
#  - If your repo uses a different default branch name, set the "base_branch" input when running the workflow.
#  - The script itself commits. The workflow creates a new branch before running the script, so protected-main rules remain respected.
on:
  workflow_dispatch:
    inputs:
      apply:
        description: 'Set to true to apply renames (create branch, commit, push, open PR). Default false = dry-run only'
        required: false
        default: 'false'
      base_branch:
        description: 'Base branch for the PR (default: main)'
        required: false
        default: 'main'

permissions:
  contents: write
  pull-requests: write

jobs:
  rename:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Ensure script is executable
        run: |
          chmod +x scripts/rename.sh

      - name: Dry run and upload plan
        if: ${{ github.event.inputs.apply != 'true' }}
        run: |
          ./scripts/rename.sh --dry | tee rename-plan.txt
        continue-on-error: false

      - name: Upload dry-run artifact
        if: ${{ github.event.inputs.apply != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: rename-plan
          path: rename-plan.txt

      - name: Create branch, run script, push branch (APPLY)
        if: ${{ github.event.inputs.apply == 'true' }}
        id: apply-run
        run: |
          set -euo pipefail
          BRANCH="rename-posts-$(date -u +%Y%m%d%H%M%S)"
          echo "Creating branch: $BRANCH"
          git checkout -b "$BRANCH"
          # ensure git has identity for commits
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          chmod +x scripts/rename.sh
          # The script will run git mv and git commit
          ./scripts/rename.sh

          echo "Pushing branch $BRANCH"
          git push --set-upstream origin "$BRANCH"

          # expose branch for subsequent steps
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Create Pull Request for rename branch
        if: ${{ github.event.inputs.apply == 'true' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = '${{ steps.apply-run.outputs.branch }}';
            const base = '${{ github.event.inputs.base_branch }}' || 'main';
            const title = 'refactor: standardize posts/ and images/ filenames to YYYY-MM-DD(-HHMM)-descriptive-name';
            const body = `Automated run of scripts/rename.sh (via GitHub Actions).
This PR contains file renames proposed by the script for posts/ and images/. Review the commit(s) and merge when ready.`;

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              head: branch,
              base,
              body,
            });
            core.info(`Created PR: ${pr.data.html_url}`);
            return pr.data.html_url
